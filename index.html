<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>IGN Map with Drawing + JSON Import + ESRI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"
    />

    <style>
      body {
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
      }
      #map {
        flex: 1;
      }
      #jsonPanel {
        width: 400px;
        overflow: auto;
        background: #f5f5f5;
        padding: 10px;
        font-family: monospace;
        border-left: 1px solid #ccc;
        white-space: pre-wrap;
        z-index: 2000;
        position: relative;
        pointer-events: auto;
        display: flex;
        flex-direction: column;
      }
      #jsonContent {
        flex: 1;
        overflow: auto;
        margin-bottom: 10px;
      }
      #buttonContainer {
        display: flex;
        gap: 8px;
      }
      #btnClear, #btnDownload {
        padding: 8px 12px;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        flex: 1;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }
      #btnClear {
        background: #ff6b6b;
      }
      #btnClear:hover, #btnClear:active {
        background: #ff5252;
      }
      #btnDownload {
        background: #4caf50;
      }
      #btnDownload:hover, #btnDownload:active {
        background: #45a049;
      }
      /* Reduce editing handle size */
      .leaflet-editing-icon {
        width: 6px !important;
        height: 6px !important;
        margin-left: -3px !important;
        margin-top: -3px !important;
        border-radius: 6px !important;
      }
      .leaflet-touch .leaflet-editing-icon {
        width: 6px !important;
        height: 6px !important;
        margin-left: -3px !important;
        margin-top: -3px !important;
      }
      /* Remove tooltips */
      .leaflet-draw-tooltip {
        display: none !important;
      }
      /* Hand cursor in pan mode */
      #map.pan-mode {
        cursor: grab !important;
      }
      #map.pan-mode:active {
        cursor: grabbing !important;
      }
      /* Control buttons */
      .leaflet-control-pan,
      .leaflet-control-toggle {
        background: white;
        width: 30px;
        height: 30px;
        border: 2px solid rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        pointer-events: auto !important;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }
      .leaflet-control-pan:hover,
      .leaflet-control-toggle:hover {
        background: #f4f4f4;
      }
      .leaflet-control-pan.active,
      .leaflet-control-toggle.active {
        background: #3388ff;
        color: white;
      }
      /* Bottom buttons for basemap switch */
      #basemapSwitch {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
      }
      #basemapSwitch button {
        padding: 6px 12px;
        margin: 0 2px;
        border: 1px solid #888;
        background: white;
        cursor: pointer;
        border-radius: 4px;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }
      #basemapSwitch button.active {
        background: #3388ff;
        color: white;
        border-color: #3388ff;
      }
      #basemapSwitch button:active {
        transform: scale(0.95);
      }
      #btnESRI {
        display: none;
      }
      /* Toast notification */
      #toast {
        position: fixed;
        bottom: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(51, 136, 255, 0.95);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-family: sans-serif;
        font-size: 14px;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }
      #toast.show {
        opacity: 1;
      }
      /* Date de prise de vue */
      #imageDate {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 6px 12px;
        border-radius: 4px;
        font-family: sans-serif;
        font-size: 12px;
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        display: none;
      }
      #imageDate.visible {
        display: block;
      }
      /* Search box */
      #searchContainer {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        width: 90%;
        max-width: 400px;
      }
      #searchBox {
        width: 100%;
        padding: 12px 40px 12px 16px;
        border: 2px solid rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        font-size: 14px;
        font-family: sans-serif;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        background: white;
        outline: none;
        box-sizing: border-box;
      }
      #searchBox:focus {
        border-color: #3388ff;
      }
      #searchIcon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #888;
        pointer-events: none;
      }
      #searchResults {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-top: 4px;
        max-height: 300px;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: none;
      }
      #searchResults.visible {
        display: block;
      }
      .search-result-item {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        font-family: sans-serif;
        font-size: 14px;
      }
      .search-result-item:last-child {
        border-bottom: none;
      }
      .search-result-item:hover {
        background: #f0f0f0;
      }
      .search-result-item:active {
        background: #e0e0e0;
      }
      .search-result-name {
        font-weight: 500;
        color: #333;
      }
      .search-result-details {
        font-size: 12px;
        color: #666;
        margin-top: 2px;
      }
      /* Mobile responsive */
      @media (max-width: 768px) {
        body {
          flex-direction: column;
        }
        #map {
          flex: 1;
          height: calc(100vh - 100px);
        }
        #jsonPanel {
          width: 100%;
          height: 100px;
          max-height: 100px;
          border-left: none;
          border-top: 1px solid #ccc;
        }
        #jsonContent {
          font-size: 10px;
          overflow: auto;
        }
        #buttonContainer {
          flex-direction: row;
        }
        #btnClear, #btnDownload {
          padding: 10px 12px;
          font-size: 14px;
          min-height: 44px;
        }
        #basemapSwitch button {
          padding: 10px 16px;
          font-size: 14px;
          min-height: 44px;
        }
        #searchContainer {
          width: calc(100% - 20px);
          max-width: none;
        }
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="imageDate"></div>
    
    <!-- Search box -->
    <div id="searchContainer">
      <div style="position: relative;">
        <input type="text" id="searchBox" placeholder="Rechercher un lieu..." />
        <span id="searchIcon">üîç</span>
      </div>
      <div id="searchResults"></div>
    </div>
    
    <div id="jsonPanel">
      <div id="jsonContent" contenteditable="true"></div>
      <div id="buttonContainer">
        <button id="btnDownload">‚¨á Download</button>
        <button id="btnClear">Clear</button>
      </div>
    </div>

    <div id="basemapSwitch">
      <button id="btnIGN" class="active">IGN</button>
      <button id="btnESRI">ESRI</button>
    </div>

    <div id="toast"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <script>
      var map = L.map("map", { maxZoom: 22 }).setView([46.6, 2.5], 6);

      // --- BASEMAPS ---
      var ortho = L.tileLayer(
        "https://data.geopf.fr/wmts?layer=ORTHOIMAGERY.ORTHOPHOTOS&style=normal&tilematrixset=PM&Service=WMTS&Request=GetTile&Version=1.0.0&Format=image/jpeg&TileMatrix={z}&TileCol={x}&TileRow={y}",
        { attribution: "¬© IGN", maxZoom: 22, maxNativeZoom: 19, minZoom: 1 },
      ).addTo(map);

      var esri = L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        { attribution: "¬© Esri", maxZoom: 22, maxNativeZoom: 19 },
      );

      // --- DRAWING ---
      var drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);

      var drawControl = new L.Control.Draw({
        edit: { featureGroup: drawnItems },
        draw: {
          polyline: false,
          rectangle: false,
          circle: false,
          circlemarker: false,
          marker: true,
          polygon: true,
        },
      });
      map.addControl(drawControl);

      // --- CUSTOM CONTROLS ---
      L.Control.Pan = L.Control.extend({
        onAdd: function (map) {
          var container = L.DomUtil.create(
            "div",
            "leaflet-bar leaflet-control leaflet-control-pan",
          );
          container.innerHTML = "‚úã";
          container.title = "Pan Mode";
          L.DomEvent.on(container, "mousedown", function(e) {
            L.DomEvent.stopPropagation(e);
            L.DomEvent.preventDefault(e);
          });
          L.DomEvent.on(container, "touchstart", function(e) {
            L.DomEvent.stopPropagation(e);
            L.DomEvent.preventDefault(e);
          });
          L.DomEvent.on(container, "dblclick", function(e) {
            L.DomEvent.stopPropagation(e);
            L.DomEvent.preventDefault(e);
          });
          L.DomEvent.on(container, "click touchend", function (e) {
            L.DomEvent.stopPropagation(e);
            L.DomEvent.preventDefault(e);
            if (container.classList.contains("active")) {
              container.classList.remove("active");
              map._container.classList.remove("pan-mode");
              map.dragging.enable();
            } else {
              container.classList.add("active");
              map._container.classList.add("pan-mode");
              map.dragging.enable();
            }
          });
          return container;
        },
      });
      L.control.pan = function (opts) {
        return new L.Control.Pan(opts);
      };

      L.Control.ToggleDrawings = L.Control.extend({
        onAdd: function (map) {
          var container = L.DomUtil.create(
            "div",
            "leaflet-bar leaflet-control leaflet-control-toggle active",
          );
          container.innerHTML = "üëÅÔ∏è";
          container.title = "Show/Hide drawings";
          var visible = true;
          L.DomEvent.on(container, "mousedown", function(e) {
            L.DomEvent.stopPropagation(e);
            L.DomEvent.preventDefault(e);
          });
          L.DomEvent.on(container, "touchstart", function(e) {
            L.DomEvent.stopPropagation(e);
            L.DomEvent.preventDefault(e);
          });
          L.DomEvent.on(container, "dblclick", function(e) {
            L.DomEvent.stopPropagation(e);
            L.DomEvent.stopPropagation(e);
            L.DomEvent.preventDefault(e);
          });
          L.DomEvent.on(container, "click touchend", function (e) {
            L.DomEvent.stopPropagation(e);
            L.DomEvent.preventDefault(e);
            visible = !visible;
            if (visible) {
              container.classList.add("active");
              map.addLayer(drawnItems);
            } else {
              container.classList.remove("active");
              map.removeLayer(drawnItems);
            }
          });
          return container;
        },
      });
      L.control.toggleDrawings = function (opts) {
        return new L.Control.ToggleDrawings(opts);
      };

      L.control.pan({ position: "topleft" }).addTo(map);
      L.control.toggleDrawings({ position: "topleft" }).addTo(map);

      // --- SEARCH FUNCTIONALITY ---
      var searchBox = document.getElementById("searchBox");
      var searchResults = document.getElementById("searchResults");
      var searchTimeout;
      var searchMarker;

      function performSearch(query) {
        if (query.length < 3) {
          searchResults.classList.remove("visible");
          return;
        }

        // Using Nominatim API for geocoding
        var url = "https://nominatim.openstreetmap.org/search?format=json&q=" + 
                  encodeURIComponent(query) + 
                  "&countrycodes=fr&limit=5&addressdetails=1";

        fetch(url)
          .then(function(response) { return response.json(); })
          .then(function(data) {
            displaySearchResults(data);
          })
          .catch(function(error) {
            console.error("Search error:", error);
          });
      }

      function displaySearchResults(results) {
        searchResults.innerHTML = "";
        
        if (results.length === 0) {
          searchResults.innerHTML = '<div class="search-result-item">Aucun r√©sultat trouv√©</div>';
          searchResults.classList.add("visible");
          return;
        }

        results.forEach(function(result) {
          var item = document.createElement("div");
          item.className = "search-result-item";
          
          var name = document.createElement("div");
          name.className = "search-result-name";
          name.textContent = result.display_name.split(",")[0];
          
          var details = document.createElement("div");
          details.className = "search-result-details";
          details.textContent = result.display_name;
          
          item.appendChild(name);
          item.appendChild(details);
          
          item.addEventListener("click", function() {
            zoomToResult(result);
          });
          
          item.addEventListener("touchend", function(e) {
            e.preventDefault();
            zoomToResult(result);
          });
          
          searchResults.appendChild(item);
        });
        
        searchResults.classList.add("visible");
      }

      function zoomToResult(result) {
        var lat = parseFloat(result.lat);
        var lon = parseFloat(result.lon);
        
        // Remove previous search marker if exists
        if (searchMarker) {
          map.removeLayer(searchMarker);
        }
        
        // Add temporary marker
        searchMarker = L.marker([lat, lon], {
          icon: L.divIcon({
            className: 'search-marker',
            html: '<div style="background: #ff4444; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
          })
        }).addTo(map);
        
        // Zoom to location
        var zoom = 16;
        if (result.boundingbox) {
          var bounds = [
            [parseFloat(result.boundingbox[0]), parseFloat(result.boundingbox[2])],
            [parseFloat(result.boundingbox[1]), parseFloat(result.boundingbox[3])]
          ];
          map.fitBounds(bounds, { padding: [50, 50], maxZoom: 18 });
        } else {
          map.setView([lat, lon], zoom);
        }
        
        // Clear search box and results
        searchBox.value = result.display_name.split(",")[0];
        searchResults.classList.remove("visible");
        searchBox.blur();
        
        // Remove marker after 5 seconds
        setTimeout(function() {
          if (searchMarker) {
            map.removeLayer(searchMarker);
            searchMarker = null;
          }
        }, 5000);
      }

      searchBox.addEventListener("input", function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
          performSearch(searchBox.value);
        }, 300);
      });

      searchBox.addEventListener("focus", function() {
        if (searchBox.value.length >= 3) {
          performSearch(searchBox.value);
        }
      });

      // Close search results when clicking outside
      document.addEventListener("click", function(e) {
        if (!searchBox.contains(e.target) && !searchResults.contains(e.target)) {
          searchResults.classList.remove("visible");
        }
      });

      // Prevent map clicks from propagating when clicking search
      document.getElementById("searchContainer").addEventListener("click", function(e) {
        e.stopPropagation();
      });

      // --- JSON PANEL ---
      var jsonPanel = document.getElementById("jsonContent");
      var btnClear = document.getElementById("btnClear");
      var btnDownload = document.getElementById("btnDownload");
      var toast = document.getElementById("toast");

      function showToast(message, duration) {
        duration = duration || 3000;
        toast.textContent = message;
        toast.classList.add("show");
        setTimeout(function() {
          toast.classList.remove("show");
        }, duration);
      }

      function updateJSONPanel() {
        var geojson = drawnItems.toGeoJSON();
        var jsonText = JSON.stringify(geojson, null, 2);
        jsonPanel.textContent = jsonText;
        localStorage.setItem("mapGeoJSON", jsonText);
      }

      function loadGeoJSONFromPanel(shouldZoom) {
        var text = jsonPanel.textContent.trim();
        if (!text) return;
        try {
          var data = JSON.parse(text);
          if (data.type === "FeatureCollection") {
            drawnItems.clearLayers();
            L.geoJSON(data, {
              pointToLayer: (f, latlng) => L.marker(latlng),
            }).eachLayer((l) => drawnItems.addLayer(l));
            localStorage.setItem("mapGeoJSON", JSON.stringify(data));
            if (shouldZoom && drawnItems.getLayers().length)
              map.fitBounds(drawnItems.getBounds(), { padding: [50, 50] });
          }
        } catch (e) {
          console.log("Invalid JSON", e);
        }
      }

      function loadGreensJSON() {
        fetch("greens.json")
          .then(function (response) {
            if (!response.ok) throw new Error("No greens.json found");
            return response.json();
          })
          .then(function (data) {
            var jsonText = JSON.stringify(data, null, 2);
            jsonPanel.textContent = jsonText;
            // Load directly without triggering input event
            if (data.type === "FeatureCollection") {
              drawnItems.clearLayers();
              L.geoJSON(data, {
                pointToLayer: (f, latlng) => L.marker(latlng),
              }).eachLayer((l) => drawnItems.addLayer(l));
              localStorage.setItem("mapGeoJSON", jsonText);
              if (drawnItems.getLayers().length)
                map.fitBounds(drawnItems.getBounds(), { padding: [50, 50] });
              showToast("üìç Greens par d√©faut charg√©s", 3000);
            }
          })
          .catch(function () {
            updateJSONPanel();
          });
      }

      map.on(L.Draw.Event.CREATED, (e) => {
        drawnItems.addLayer(e.layer);
        updateJSONPanel();
      });
      map.on("draw:edited draw:deleted", updateJSONPanel);

      // Fonction pour g√©rer les clics (desktop et mobile)
      function handleClick(callback) {
        return function(e) {
          e.stopPropagation();
          e.preventDefault();
          callback();
        };
      }

      btnClear.addEventListener("click", handleClick(function() {
        localStorage.removeItem("mapGeoJSON");
        drawnItems.clearLayers();
        jsonPanel.textContent = "";
        updateJSONPanel();
      }));

      btnClear.addEventListener("touchend", handleClick(function() {
        localStorage.removeItem("mapGeoJSON");
        drawnItems.clearLayers();
        jsonPanel.textContent = "";
        updateJSONPanel();
      }));

      btnDownload.addEventListener("click", handleClick(function() {
        var text = jsonPanel.textContent.trim();
        if (!text) {
          showToast("‚ö†Ô∏è Aucune donn√©e √† t√©l√©charger", 2000);
          return;
        }
        
        var blob = new Blob([text], { type: "application/json" });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = "greens-" + new Date().toISOString().split('T')[0] + ".json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast("‚úÖ T√©l√©chargement d√©marr√©", 2000);
      }));

      btnDownload.addEventListener("touchend", handleClick(function() {
        var text = jsonPanel.textContent.trim();
        if (!text) {
          showToast("‚ö†Ô∏è Aucune donn√©e √† t√©l√©charger", 2000);
          return;
        }
        
        var blob = new Blob([text], { type: "application/json" });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = "greens-" + new Date().toISOString().split('T')[0] + ".json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast("‚úÖ T√©l√©chargement d√©marr√©", 2000);
      }));

      // --- PANEL INPUT / PASTE ---
      var inputTimeout;
      jsonPanel.addEventListener("input", () => {
        clearTimeout(inputTimeout);
        inputTimeout = setTimeout(() => loadGeoJSONFromPanel(true), 1000);
      });
      jsonPanel.addEventListener("paste", (e) => {
        e.preventDefault();
        jsonPanel.textContent = (
          e.clipboardData || window.clipboardData
        ).getData("text");
        setTimeout(() => loadGeoJSONFromPanel(true), 100);
      });

      // --- LOAD LOCALSTORAGE or greens.json ---
      window.addEventListener('load', function() {
        var savedData = localStorage.getItem("mapGeoJSON");
        var shouldLoadGreens = true;
        
        if (savedData) {
          try {
            var data = JSON.parse(savedData);
            // Check if there are actual features
            if (data.type === "FeatureCollection" && data.features && data.features.length > 0) {
              jsonPanel.textContent = savedData;
              loadGeoJSONFromPanel(true);
              shouldLoadGreens = false;
            }
          } catch (e) {
            console.log("Invalid saved data", e);
          }
        }
        
        if (shouldLoadGreens) {
          loadGreensJSON();
        }
      });

      // --- SWITCH BASEMAPS ---
      var btnIGN = document.getElementById("btnIGN"),
        btnESRI = document.getElementById("btnESRI");
      var imageDate = document.getElementById("imageDate");
      
      // Fonction pour r√©cup√©rer la date de prise de vue IGN
      function updateImageDate() {
        if (!map.hasLayer(ortho)) {
          imageDate.classList.remove("visible");
          return;
        }
        
        var center = map.getCenter();
        var zoom = map.getZoom();
        
        // API IGN pour obtenir les m√©tadonn√©es de la couche
        var url = "https://data.geopf.fr/wmts?" +
          "layer=ORTHOIMAGERY.ORTHOPHOTOS&" +
          "style=normal&" +
          "tilematrixset=PM&" +
          "Service=WMTS&" +
          "Request=GetFeatureInfo&" +
          "Version=1.0.0&" +
          "Format=image/jpeg&" +
          "TileMatrix=" + Math.floor(zoom) + "&" +
          "TileCol=" + Math.floor((center.lng + 180) / 360 * Math.pow(2, Math.floor(zoom))) + "&" +
          "TileRow=" + Math.floor((1 - Math.log(Math.tan(center.lat * Math.PI / 180) + 1 / Math.cos(center.lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, Math.floor(zoom))) + "&" +
          "I=128&J=128&" +
          "InfoFormat=application/json";
        
        fetch(url)
          .then(function(response) { return response.json(); })
          .then(function(data) {
            if (data && data.features && data.features.length > 0) {
              var date = data.features[0].properties.date_vol || data.features[0].properties.date;
              if (date) {
                imageDate.textContent = "üìÖ Prise de vue : " + date;
                imageDate.classList.add("visible");
              }
            }
          })
          .catch(function() {
            // En cas d'erreur, on affiche une date g√©n√©rique
            imageDate.textContent = "üìÖ Orthophoto IGN";
            imageDate.classList.add("visible");
          });
      }
      
      function switchToIGN() {
        map.removeLayer(esri);
        map.addLayer(ortho);
        btnIGN.classList.add("active");
        btnESRI.classList.remove("active");
        updateImageDate();
      }

      function switchToESRI() {
        map.removeLayer(ortho);
        map.addLayer(esri);
        btnESRI.classList.add("active");
        btnIGN.classList.remove("active");
        imageDate.classList.remove("visible");
      }

      btnIGN.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();
        switchToIGN();
      });

      btnIGN.addEventListener("touchend", function(e) {
        e.preventDefault();
        e.stopPropagation();
        switchToIGN();
      });

      btnESRI.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();
        switchToESRI();
      });

      btnESRI.addEventListener("touchend", function(e) {
        e.preventDefault();
        e.stopPropagation();
        switchToESRI();
      });
      
      // Mettre √† jour la date quand on d√©place la carte
      map.on("moveend", function() {
        if (map.hasLayer(ortho)) {
          updateImageDate();
        }
      });
      
      // Afficher la date au chargement initial
      updateImageDate();
    </script>
  </body>
</html>